<!DOCTYPE html>
<html lang="ru">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
    <title> Батутный Парк "Космос" </title>
    <body> 
    </body>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for neon glow effects and background image */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0a1f; /* Very dark blue/purple for cosmic feel */
            color: #e0e0e0; /* Light gray for general text */
            background-image: url('https://placehold.co/1920x1080/0d0a1f/e0e0e0?text=Космический+фон'); /* Placeholder for background */
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Keeps background fixed when scrolling */
            overflow-x: hidden; /* Prevent horizontal scroll due to cubes */
        }

        /* Neon text shadow for headings */
        .neon-text-glow {
            text-shadow: 0 0 5px #f0abfc, 0 0 10px #f0abfc, 0 0 15px #f0abfc, 0 0 20px #a78bfa, 0 0 30px #a78bfa;
        }

        /* Neon box shadow for cards/sections */
        .neon-box-glow {
            box-shadow: 0 0 10px rgba(240, 171, 252, 0.6), 0 0 20px rgba(167, 139, 250, 0.4);
        }

        /* Active tab button style */
        .tab-button.active {
            background-color: #a78bfa; /* Brighter purple for active tab */
            color: white;
            box-shadow: 0 0 15px #a78bfa, 0 0 25px #a78bfa; /* Stronger glow */
        }

        /* Input field adjustments for dark theme */
        input[type="date"],
        input[type="number"],
        input[type="text"],
        input[type="tel"],
        select {
            background-color: #2a214d; /* Darker input background */
            border-color: #6d28d9; /* Purple border */
            color: #e0e0e0; /* Light text color */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Ensures calendar icon is visible */
        }
        input:focus, select:focus {
            border-color: #c084fc; /* Lighter purple on focus */
            ring-color: #c084fc;
        }
        /* Placeholder text color */
        input::placeholder {
            color: #a78bfa; /* Light purple placeholder */
            opacity: 0.7;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1438; /* Darker track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #6d28d9; /* Purple thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6; /* Lighter purple on hover */
        }

        /* Cube animation */
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }

        .cube {
            position: absolute;
            border-radius: 2px; /* Slightly rounded corners for cubes */
            opacity: 0; /* Start hidden */
            animation: twinkle 3s infinite ease-in-out; /* Twinkling effect */
            pointer-events: none; /* Allow clicks to pass through */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

    <!-- Cubes Container - positioned absolutely to cover the background -->
    <div id="cubes-container" class="fixed inset-0 overflow-hidden z-0"></div>

    <div class="bg-gradient-to-br from-[#1a1438] to-[#0d0a1f] rounded-xl shadow-lg p-6 sm:p-8 lg:p-10 w-full max-w-4xl border border-purple-700 neon-box-glow z-10 relative">
        <!-- Logo in Header -->
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-fuchsia-500 mb-6 sm:mb-8">
           <div class="logo-container">
            <img src="logo.jpeg"
                 alt="Батутный Парк Космос Логотип"
                 class="mx-auto w-full max-w-md h-auto object-contain neon-box-glow"
                 onerror="this.onerror=null;this.src='https://placehold.co/300x100/0d0a1f/fuchsia?text=Логотип+не+найден';">
        </h1>

        <!-- Tab Navigation -->
        <div class="flex flex-col sm:flex-row justify-center gap-3 mb-8">
            <button id="tab-regular" class="tab-button active px-6 py-3 rounded-lg font-semibold text-lg transition duration-300 ease-in-out bg-purple-700 hover:bg-purple-800 text-white shadow-md">
                Разовое посещение
            </button>
            <button id="tab-birthday" class="tab-button px-6 py-3 rounded-lg font-semibold text-lg transition duration-300 ease-in-out bg-gray-700 hover:bg-gray-600 text-gray-200">
                День рождения
            </button>
            <button id="tab-group" class="tab-button px-6 py-3 rounded-lg font-semibold text-lg transition duration-300 ease-in-out bg-gray-700 hover:bg-gray-600 text-gray-200">
                Групповые бронирования
            </button>
        </div>

        <!-- Booking Sections -->
        <div id="regular-booking" class="booking-section">
            <h2 class="text-2xl font-semibold text-cyan-400 mb-5 neon-text-glow">Разовое посещение</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Personal Data -->
                <div class="flex flex-col md:col-span-2">
                    <label for="regular-name" class="block text-fuchsia-300 font-medium mb-2">Имя:</label>
                    <input type="text" id="regular-name" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label for="regular-phone" class="block text-fuchsia-300 font-medium mb-2">Номер телефона (в формате +7):</label>
                    <input type="tel" id="regular-phone" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500" pattern="^\+7[0-9]{10}$" placeholder="+7" required>
                </div>

                <!-- Date Selection -->
                <div class="flex flex-col">
                    <label for="regular-date" class="block text-fuchsia-300 font-medium mb-2">Дата:</label>
                    <input type="date" id="regular-date" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Number of People -->
                <div class="flex flex-col">
                    <label class="block text-fuchsia-300 font-medium mb-2">Кол-во человек (1-20):</label>
                    <div class="flex items-center space-x-3">
                        <button id="regular-minus" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xl transition duration-200 ease-in-out shadow-sm neon-box-glow">-</button>
                        <input type="number" id="regular-people" value="1" min="1" max="20" class="w-20 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <button id="regular-plus" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xl transition duration-200 ease-in-out shadow-sm neon-box-glow">+</button>
                    </div>
                </div>

                <!-- Time Duration -->
                <div class="flex flex-col md:col-span-2">
                    <label class="block text-fuchsia-300 font-medium mb-2">Время:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="regular-duration" value="30" class="form-radio h-5 w-5 text-cyan-400" checked>
                            <span class="ml-2 text-gray-100">30 минут</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="regular-duration" value="60" class="form-radio h-5 w-5 text-cyan-400">
                            <span class="ml-2 text-gray-100">60 минут</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="regular-duration" value="120" class="form-radio h-5 w-5 text-cyan-400">
                            <span class="ml-2 text-gray-100">120 минут</span>
                        </label>
                    </div>
                </div>

                <!-- Available Time Slots -->
                <div class="flex flex-col md:col-span-2">
                    <label class="block text-fuchsia-300 font-medium mb-2">Доступное время:</label>
                    <select id="regular-time-slot" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <!-- Options will be populated by JS -->
                    </select>
                    <p id="regular-availability-message" class="text-sm text-red-400 mt-2 hidden"></p>
                </div>

                <!-- Total Price -->
                <div class="md:col-span-2 text-center mt-6">
                    <p class="text-xl font-semibold text-gray-100">Общая стоимость: <span id="regular-total-price" class="text-cyan-400 text-2xl neon-text-glow">0</span> ₽</p>
                    <button id="book-regular" class="mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 ease-in-out shadow-lg neon-box-glow">
                        Забронировать
                    </button>
                </div>
            </div>
        </div>

        <div id="birthday-booking" class="booking-section hidden">
            <h2 class="text-2xl font-semibold text-cyan-400 mb-5 neon-text-glow">Бронирование "День рождения"</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Personal Data -->
                <div class="flex flex-col md:col-span-2">
                    <label for="birthday-name" class="block text-fuchsia-300 font-medium mb-2">Имя:</label>
                    <input type="text" id="birthday-name" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label for="birthday-phone" class="block text-fuchsia-300 font-medium mb-2">Номер телефона (в формате +7):</label>
                    <input type="tel" id="birthday-phone" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500" pattern="^\+7[0-9]{10}$" placeholder="+7" required>
                </div>

                <!-- Date Selection -->
                <div class="flex flex-col">
                    <label for="birthday-date" class="block text-fuchsia-300 font-medium mb-2">Дата:</label>
                    <input type="date" id="birthday-date" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Number of People -->
                <div class="flex flex-col">
                    <label class="block text-fuchsia-300 font-medium mb-2">Кол-во человек:</label>
                    <div class="flex items-center space-x-3">
                        <button id="birthday-minus" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xl transition duration-200 ease-in-out shadow-sm neon-box-glow">-</button>
                        <input type="number" id="birthday-people" value="1" min="1" max="20" class="w-20 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <button id="birthday-plus" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xl transition duration-200 ease-in-out shadow-sm neon-box-glow">+</button>
                    </div>
                </div>

                <!-- Start Time -->
                <div class="flex flex-col">
                    <label class="block text-fuchsia-300 font-medium mb-2">Время начала:</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="birthday-start-hour" value="10" min="0" max="23" class="w-16 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <span class="text-xl text-gray-100">:</span>
                        <input type="number" id="birthday-start-minute" value="00" min="0" max="59" step="30" class="w-16 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                </div>

                <!-- End Time -->
                <div class="flex flex-col">
                    <label class="block text-fuchsia-300 font-medium mb-2">Время окончания:</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="birthday-end-hour" value="12" min="0" max="23" class="w-16 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <span class="text-xl text-gray-100">:</span>
                        <input type="number" id="birthday-end-minute" value="00" min="0" max="59" step="30" class="w-16 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                </div>
                <p id="birthday-duration-message" class="text-sm text-red-400 mt-2 hidden md:col-span-2"></p>
                <p id="birthday-availability-message" class="text-sm text-red-400 mt-2 hidden md:col-span-2"></p>


                <!-- Total Price -->
                <div class="md:col-span-2 text-center mt-6">
                    <p class="text-xl font-semibold text-gray-100">Общая стоимость: <span id="birthday-total-price" class="text-cyan-400 text-2xl neon-text-glow">0</span>₽</p>
                    <button id="book-birthday" class="mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 ease-in-out shadow-lg neon-box-glow">
                        Забронировать День Рождения
                    </button>
                </div>
            </div>
        </div>

        <div id="group-booking" class="booking-section hidden">
            <h2 class="text-2xl font-semibold text-cyan-400 mb-5 neon-text-glow">Групповые бронирования (от 10 чел)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Personal Data -->
                <div class="flex flex-col md:col-span-2">
                    <label for="group-name" class="block text-fuchsia-300 font-medium mb-2">Имя:</label>
                    <input type="text" id="group-name" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label for="group-phone" class="block text-fuchsia-300 font-medium mb-2">Номер телефона (+7XXXXXXXXXX):</label>
                    <input type="tel" id="group-phone" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500" pattern="^\+7[0-9]{10}$" placeholder="+7XXXXXXXXXX" required>
                </div>

                <!-- Date Selection -->
                <div class="flex flex-col">
                    <label for="group-date" class="block text-fuchsia-300 font-medium mb-2">Дата:</label>
                    <input type="date" id="group-date" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Number of People -->
                <div class="flex flex-col">
                    <label class="block text-fuchsia-300 font-medium mb-2">Кол-во человек (от 10):</label>
                    <div class="flex items-center space-x-3">
                        <button id="group-minus" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xl transition duration-200 ease-in-out shadow-sm neon-box-glow">-</button>
                        <input type="number" id="group-people" value="15" min="10" max="100" class="w-20 text-center p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <button id="group-plus" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xl transition duration-200 ease-in-out shadow-sm neon-box-glow">+</button>
                    </div>
                </div>

                <!-- Available Time Slots (for 1 hour only) -->
                <div class="flex flex-col md:col-span-2">
                    <label class="block text-fuchsia-300 font-medium mb-2">Доступное время (1 час):</label>
                    <select id="group-time-slot" class="p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <!-- Options will be populated by JS -->
                    </select>
                    <p id="group-availability-message" class="text-sm text-red-400 mt-2 hidden"></p>
                </div>

                <!-- Total Price -->
                <div class="md:col-span-2 text-center mt-6">
                    <p class="text-xl font-semibold text-gray-100">Общая стоимость: <span id="group-total-price" class="text-cyan-400 text-2xl neon-text-glow">0</span> ₽</p>
                    <button id="book-group" class="mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 ease-in-out shadow-lg neon-box-glow">
                        Забронировать группу
                    </button>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-gradient-to-br from-[#1a1438] to-[#0d0a1f] rounded-lg shadow-xl p-6 w-full max-w-sm text-center border border-purple-700 neon-box-glow">
                <p id="message-text" class="text-lg font-medium text-gray-100 mb-4"></p>
                <button id="message-ok-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 ease-in-out neon-box-glow">ОК</button>
            </div>
        </div>
    </div>

    <!-- Админ-панель -->
    <div id="admin-panel" class="fixed bottom-4 right-4 bg-gray-800 p-4 rounded-lg shadow-lg border border-purple-600 neon-box-glow hidden w-full max-w-md z-50">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-white font-bold text-lg">Админ-панель</h3>
            <button id="close-admin" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm mb-1">Google Таблица (подключена через Apps Script):</label>
            <div class="bg-gray-700 text-gray-200 px-3 py-2 rounded text-sm mb-2">
                ID: 1i0Bjp7d59QzeEnZgsbdVR16TQTFcVNPfhSmX6WNm34Q
            </div>
        </div>
        
        <div class="flex flex-col gap-2 mb-4">
            <button id="sync-bookings" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    Синхронизировать с Google Таблицей
                </span>
            </button>
            <button id="clear-test-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Очистить все бронирования в Таблице
                </span>
            </button>
        </div>
        
        <div class="mt-3">
            <h4 class="text-gray-300 font-medium mb-2">Активные бронирования:</h4>
            <div id="bookings-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
        </div>
    </div>
    <button id="admin-toggle" class="fixed bottom-4 right-4 bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md neon-box-glow z-20">
        Админ
    </button>
    
    <script>
        // ===== КОНФИГУРАЦИЯ =====
        // Замените этот URL на URL вашего развернутого Google Apps Script!
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzyvuyhw4EAU5xWP35fanJ71eyJEbKVxSUwBdx_1sZ2Y8-O3kJ1ouvhokEXj__wZ4jT/exec';
        const ADMIN_PASSWORD = "cosmos2105"; // ВНИМАНИЕ: Это не безопасно для реального приложения!

        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const bookingSections = document.querySelectorAll('.booking-section');

        // Regular Booking Elements
        const regularNameInput = document.getElementById('regular-name');
        const regularPhoneInput = document.getElementById('regular-phone');
        const regularDateInput = document.getElementById('regular-date');
        const regularPeopleInput = document.getElementById('regular-people');
        const regularMinusBtn = document.getElementById('regular-minus');
        const regularPlusBtn = document.getElementById('regular-plus');
        const regularDurationRadios = document.querySelectorAll('input[name="regular-duration"]');
        const regularTimeSlotSelect = document.getElementById('regular-time-slot');
        const regularAvailabilityMessage = document.getElementById('regular-availability-message');
        const regularTotalPriceSpan = document.getElementById('regular-total-price');
        const bookRegularBtn = document.getElementById('book-regular');

        // Birthday Booking Elements
        const birthdayNameInput = document.getElementById('birthday-name');
        const birthdayPhoneInput = document.getElementById('birthday-phone');
        const birthdayDateInput = document.getElementById('birthday-date');
        const birthdayPeopleInput = document.getElementById('birthday-people');
        const birthdayMinusBtn = document.getElementById('birthday-minus');
        const birthdayPlusBtn = document.getElementById('birthday-plus');
        const birthdayStartHourInput = document.getElementById('birthday-start-hour');
        const birthdayStartMinuteInput = document.getElementById('birthday-start-minute');
        const birthdayEndHourInput = document.getElementById('birthday-end-hour');
        const birthdayEndMinuteInput = document.getElementById('birthday-end-minute');
        const birthdayDurationMessage = document.getElementById('birthday-duration-message');
        const birthdayAvailabilityMessage = document.getElementById('birthday-availability-message');
        const birthdayTotalPriceSpan = document.getElementById('birthday-total-price');
        const bookBirthdayBtn = document.getElementById('book-birthday');

        // Group Booking Elements
        const groupNameInput = document.getElementById('group-name');
        const groupPhoneInput = document.getElementById('group-phone'); // Corrected typo
        const groupDateInput = document.getElementById('group-date');
        const groupPeopleInput = document.getElementById('group-people');
        const groupMinusBtn = document.getElementById('group-minus');
        const groupPlusBtn = document.getElementById('group-plus');
        const groupTimeSlotSelect = document.getElementById('group-time-slot');
        const groupAvailabilityMessage = document.getElementById('group-availability-message');
        const groupTotalPriceSpan = document.getElementById('group-total-price');
        const bookGroupBtn = document.getElementById('book-group');

        // Message Box Elements
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkButton = document.getElementById('message-ok-button');

        // Cubes Container Element
        const cubesContainer = document.getElementById('cubes-container');

        // --- Global State ---
        // Stores booked slots. This will now be populated from Google Sheets.
        // Structure: { id: 'uniqueId', date: 'YYYY-MM-DD', startHour: H, startMinute: M, durationMinutes: D, people: N, type: 'regular' | 'birthday' | 'group', name: 'N', phone: 'P' }
        let bookedSlots = [];

        // Define holidays for price calculation (example for 2025)
        const holidays = [
            '2025-01-01', // Новый год
            '2025-01-07', // Рождество
            '2025-02-23', // День защитника Отечества
            '2025-03-08', // Международный женский день
            '2025-05-01', // Праздник Весны и Труда
            '2025-05-09', // День Победы
            '2025-06-12', // День России
            '2025-11-04'  // День народного единства
        ];

        const CAPACITY_PER_SLOT = 12; // Max people per 30-min segment for regular bookings

        // ===== ФУНКЦИИ ДЛЯ АДМИН-ПАНЕЛИ (С ИНТЕГРАЦИЕЙ APPS SCRIPT) =====
        const adminPanel = document.getElementById('admin-panel');
        const adminToggle = document.getElementById('admin-toggle');
        const closeAdmin = document.getElementById('close-admin');
        const clearTestBtn = document.getElementById('clear-test-btn');
        const syncBookingsBtn = document.getElementById('sync-bookings');
        const bookingsList = document.getElementById('bookings-list');

        adminToggle.addEventListener('click', function() {
            if (adminPanel.classList.contains('hidden')) {
                const password = prompt("Введите пароль администратора:"); // Using native prompt for simplicity
                if (password === ADMIN_PASSWORD) {
                    adminPanel.classList.remove('hidden');
                    refreshBookingsList(); // Refresh list when admin panel opens
                } else {
                    showMessageBox("Неверный пароль.");
                }
            } else {
                adminPanel.classList.add('hidden');
            }
        });

        closeAdmin.addEventListener('click', function() {
            adminPanel.classList.add('hidden');
        });

        syncBookingsBtn.addEventListener('click', async function() {
            await getBookingsFromSheet(); // Fetch from sheet
            refreshBookingsList(); // Display fetched bookings
            showMessageBox("Список бронирований обновлен из Google Таблицы.");
        });

        clearTestBtn.addEventListener('click', function() {
            showMessageBox("Вы уверены, что хотите очистить ВСЕ бронирования в Google Таблице? Это действие необратимо.", true, async () => {
                await clearAllBookingsInSheet(); // Clear in sheet
                await getBookingsFromSheet(); // Re-fetch to update local state
                refreshBookingsList();
                // Re-populate time slots and recalculate prices for all tabs
                populateRegularTimeSlots();
                calculateRegularPrice();
                calculateBirthdayPrice();
                populateGroupTimeSlots();
                calculateGroupPrice();
                showMessageBox("Все бронирования очищены в Google Таблице.");
            });
        });

        function refreshBookingsList() {
            bookingsList.innerHTML = ''; // Clear current list
            if (bookedSlots.length === 0) {
                bookingsList.innerHTML = '<p class="text-gray-400 text-sm">Нет активных бронирований.</p>';
                return;
            }

            bookedSlots.forEach(booking => {
                const bookingDiv = document.createElement('div');
                bookingDiv.classList.add('bg-gray-700', 'p-3', 'rounded-md', 'shadow-sm', 'flex', 'justify-between', 'items-center', 'neon-box-glow');
                bookingDiv.innerHTML = `
                    <div>
                        <p class="text-white font-medium">${booking.name} (${booking.type === 'regular' ? 'Разовое' : booking.type === 'birthday' ? 'ДР' : 'Группа'})</p>
                        <p class="text-gray-300 text-sm">${booking.date} ${formatTime(booking.starthour)}:${formatTime(booking.startminute)} - ${booking.durationminutes} мин, ${booking.people} чел.</p>
                        <p class="text-gray-400 text-xs">Тел: ${booking.phone}</p>
                    </div>
                    <!-- Отмена бронирования через Apps Script не реализована в этом примере,
                         так как требует более сложной логики удаления по ID в таблице.
                         Поэтому кнопка закомментирована. -->
                    <!-- <button data-booking-id="${booking.id}" class="cancel-booking-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-md">Отменить</button> -->
                `;
                bookingsList.appendChild(bookingDiv);
            });

            // If cancel functionality were implemented, event listeners would go here:
            // document.querySelectorAll('.cancel-booking-btn').forEach(button => {
            //     button.addEventListener('click', (event) => {
            //         const bookingId = event.target.dataset.bookingId;
            //         showMessageBox(`Вы уверены, что хотите отменить бронирование ID: ${bookingId}?`, true, async () => {
            //             // await cancelBookingInSheet(bookingId); // Call Apps Script to cancel
            //             // await getBookingsFromSheet(); // Re-fetch to update local state
            //             // refreshBookingsList();
            //             // showMessageBox(`Бронирование ID: ${bookingId} отменено.`);
            //         });
            //     });
            // });
        }


        // ===== ФУНКЦИИ ДЛЯ ИНТЕГРАЦИИ С GOOGLE APPS SCRIPT =====

        /**
         * Saves a booking to the Google Sheet via Apps Script.
         * @param {object} bookingData - The booking object to save.
         * @returns {Promise<object>} The response from the Apps Script.
         */
        async function saveBookingToSheet(bookingData) {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Required for cross-origin requests
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData),
                });
                const result = await response.json();
                if (result.status === 'error') {
                    console.error('Error from Apps Script:', result.message);
                    showMessageBox(`Ошибка при сохранении: ${result.message}`);
                }
                return result;
            } catch (error) {
                console.error('Network or parsing error:', error);
                showMessageBox(`Ошибка сети или сервера: ${error.message}`);
                return { status: 'error', message: `Network or parsing error: ${error.message}` };
            }
        }

        /**
         * Fetches all bookings from the Google Sheet via Apps Script.
         * Updates the global `bookedSlots` array.
         * @returns {Promise<void>}
         */
        async function getBookingsFromSheet() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'GET',
                    mode: 'cors'
                });
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    bookedSlots = result.data;
                    console.log('Bookings fetched:', bookedSlots);
                } else {
                    console.error('Error fetching bookings from Apps Script:', result.message);
                    showMessageBox(`Ошибка при загрузке бронирований: ${result.message}`);
                    bookedSlots = []; // Clear local state on error
                }
            } catch (error) {
                console.error('Network or parsing error fetching bookings:', error);
                showMessageBox(`Ошибка сети или сервера при загрузке бронирований: ${error.message}`);
                bookedSlots = []; // Clear local state on error
            }
        }

        /**
         * Clears all bookings in the Google Sheet via Apps Script.
         * @returns {Promise<object>} The response from the Apps Script.
         */
        async function clearAllBookingsInSheet() {
            try {
                // Call the Apps Script function specifically designed to clear all bookings
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=clearAll`, {
                    method: 'GET', // Using GET for simplicity to trigger a function, POST would be more appropriate for actual deletion
                    mode: 'cors'
                });
                const result = await response.json();
                if (result.status === 'error') {
                    console.error('Error clearing bookings from Apps Script:', result.message);
                    showMessageBox(`Ошибка при очистке бронирований: ${result.message}`);
                }
                return result;
            } catch (error) {
                console.error('Network or parsing error clearing bookings:', error);
                showMessageBox(`Ошибка сети или сервера при очистке бронирований: ${error.message}`);
                return { status: 'error', message: `Network or parsing error: ${error.message}` };
            }
        }


        // ===== ОСНОВНЫЕ ФУНКЦИИ =====
        /**
         * Generates a unique booking ID.
         * @returns {string} A unique ID string.
         */
        function generateBookingId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         * @param {boolean} [isConfirm=false] - If true, adds a "No" button for confirmation.
         * @param {Function} [onConfirm=() => {}] - Callback function if "Yes" is clicked for confirm.
         */
        function showMessageBox(message, isConfirm = false, onConfirm = () => {}) {
            messageText.textContent = message;
            messageOkButton.textContent = isConfirm ? "Да" : "ОК";
            messageBox.classList.remove('hidden');

            // Remove previous listeners to prevent multiple calls
            messageOkButton.removeEventListener('click', hideMessageBox);
            messageOkButton.removeEventListener('click', onConfirm);

            // Ensure no "No" button exists before potentially adding one
            const existingNoButton = messageBox.querySelector('#message-no-button');
            if (existingNoButton) existingNoButton.remove();

            if (isConfirm) {
                messageOkButton.addEventListener('click', () => {
                    onConfirm();
                    hideMessageBox();
                });
                let noButton = document.createElement('button');
                noButton.id = 'message-no-button';
                noButton.classList.add('bg-gray-600', 'hover:bg-gray-700', 'text-white', 'font-bold', 'py-2', 'px-6', 'rounded-lg', 'transition', 'duration-200', 'ease-in-out', 'neon-box-glow', 'ml-4');
                noButton.textContent = 'Нет';
                noButton.addEventListener('click', hideMessageBox);
                messageBox.querySelector('.bg-gradient-to-br').appendChild(noButton);
            } else {
                messageOkButton.addEventListener('click', hideMessageBox);
            }
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            const noButton = messageBox.querySelector('#message-no-button');
            if (noButton) noButton.remove(); // Remove "No" button if it exists
        }

        /**
         * Formats a number to always have two digits (e.g., 5 -> "05").
         * @param {number} num - The number to format.
         * @returns {string} The formatted string.
         */
        function formatTime(num) {
            return num < 10 ? '0' + num : '' + num;
        }

        /**
         * Calculates the day type (weekday, weekend, holiday) for pricing.
         * @param {string} dateString - Date in 'YYYY-MM-DD' format.
         * @returns {'monday_thursday' | 'other_weekday' | 'weekend_holiday'}
         */
        function getDayType(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Add T00:00:00 to avoid timezone issues
            const dayOfWeek = date.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday

            if (holidays.includes(dateString)) {
                return 'weekend_holiday';
            }
            if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                return 'weekend_holiday';
            }
            if (dayOfWeek === 1 || dayOfWeek === 4) { // Monday or Thursday
                return 'monday_thursday';
            }
            return 'other_weekday'; // Tuesday, Wednesday, Friday
        }

        /**
         * Calculates the base price per person for a given duration and day type.
         * @param {number} durationMinutes - Duration in minutes (30, 60, 120).
         * @param {'monday_thursday' | 'other_weekday' | 'weekend_holiday'} dayType - Type of day.
         * @returns {number} Price per person.
         */
        function getBasePrice(durationMinutes, dayType) {
            if (dayType === 'monday_thursday') {
                // Assuming a fixed price for Monday/Thursday regardless of duration, as per original code's simplicity.
                // If different durations have different prices for Mon/Thu, this needs adjustment.
                return 350;
            } else if (dayType === 'other_weekday') {
                if (durationMinutes === 30) return 300;
                if (durationMinutes === 60) return 500;
                if (durationMinutes === 120) return 800;
            } else if (dayType === 'weekend_holiday') {
                if (durationMinutes === 30) return 400;
                if (durationMinutes === 60) return 600;
                if (durationMinutes === 120) return 1000;
            }
            return 0; // Should not happen
        }

        /**
         * Checks if a given time slot is available for a new booking.
         * Capacity is 12 people per 30-minute segment.
         * Birthday and Group bookings are considered exclusive and block all other bookings.
         * @param {string} dateString - Date in 'YYYY-MM-DD' format.
         * @param {number} startHour - Start hour of the new booking.
         * @param {number} startMinute - Start minute of the new booking.
         * @param {number} durationMinutes - Duration of the new booking.
         * @param {number} newPeople - Number of people for the new booking.
         * @param {string} bookingType - 'regular' | 'birthday' | 'group'.
         * @returns {boolean} True if available, false otherwise.
         */
        function checkAvailability(dateString, startHour, startMinute, durationMinutes, newPeople, bookingType) {
            const newBookingStart = new Date(`${dateString}T${formatTime(startHour)}:${formatTime(startMinute)}:00`);
            const newBookingEnd = new Date(newBookingStart.getTime() + durationMinutes * 60 * 1000);

            // Filter bookings for the same date
            const bookingsOnSameDate = bookedSlots.filter(slot => slot.date === dateString);

            // --- Logic for Birthday and Group Bookings (Exclusive) ---
            if (bookingType === 'birthday' || bookingType === 'group') {
                // Check if ANY existing booking (regular, birthday, or group) overlaps with this exclusive booking.
                // Exclusive bookings require the entire space for their duration.
                for (const slot of bookingsOnSameDate) {
                    const existingStart = new Date(`${slot.date}T${formatTime(slot.starthour)}:${formatTime(slot.startminute)}:00`);
                    const existingEnd = new Date(existingStart.getTime() + slot.durationminutes * 60 * 1000);

                    // Check for overlap: (StartA < EndB) && (EndA > StartB)
                    if (newBookingStart < existingEnd && newBookingEnd > existingStart) {
                        return false; // Overlap detected, exclusive slot is not available
                    }
                }
                return true; // No overlaps with any existing bookings, so it's available
            }

            // --- Logic for Regular Bookings (Capacity-based) ---
            // Regular bookings check capacity per 30-min interval.
            // They are blocked by exclusive bookings, and share capacity with other regular bookings.
            let segmentStart = new Date(newBookingStart);
            while (segmentStart < newBookingEnd) {
                const segmentEnd = new Date(segmentStart.getTime() + 30 * 60 * 1000);

                let peopleInThisSegment = 0;

                for (const slot of bookingsOnSameDate) {
                    const existingStart = new Date(`${slot.date}T${formatTime(slot.starthour)}:${formatTime(slot.startminute)}:00`);
                    const existingEnd = new Date(existingStart.getTime() + slot.durationminutes * 60 * 1000);

                    // Check if existing booking overlaps with the current 30-min segment
                    if (segmentStart < existingEnd && segmentEnd > existingStart) {
                        if (slot.type === 'birthday' || slot.type === 'group') {
                            // If an exclusive booking overlaps with this segment, it blocks the entire segment for regular bookings.
                            return false;
                        } else {
                            // If it's another regular booking, add its people to the count for this segment.
                            peopleInThisSegment += slot.people;
                        }
                    }
                }

                // Check if adding the new regular booking exceeds capacity for this segment
                if (peopleInThisSegment + newPeople > CAPACITY_PER_SLOT) {
                    return false; // Capacity exceeded for this 30-min segment
                }

                segmentStart = new Date(segmentEnd); // Move to the next 30-min segment
            }

            return true; // All segments are available
        }


        /**
         * Populates the time slot dropdown for regular and group bookings.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         * @param {string} dateString - The selected date.
         * @param {number} durationMinutes - The selected duration (e.g., 60 for 1 hour).
         * @param {number} numPeople - The number of people for the booking.
         * @param {string} bookingType - 'regular' or 'group'.
         */
        function populateTimeSlots(selectElement, dateString, durationMinutes, numPeople, bookingType) {
            selectElement.innerHTML = ''; // Clear previous options
            const now = new Date();
            const todayString = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            let hasAvailableSlots = false;

            for (let hour = 10; hour < 22; hour++) { // Park operating hours: 10:00 to 21:00 (last booking starts at 21:00 for 60 min, ends 22:00)
                for (let minute = 0; minute < 60; minute += 30) {
                    const slotStartHour = hour;
                    const slotStartMinute = minute;
                    const slotEndHour = hour + Math.floor((minute + durationMinutes) / 60);
                    const slotEndMinute = (minute + durationMinutes) % 60;

                    // Ensure the slot ends within operating hours (e.g., before 23:00)
                    if (slotEndHour > 22 || (slotEndHour === 22 && slotEndMinute > 0)) {
                        continue;
                    }

                    // Don't show past slots for today
                    if (dateString === todayString &&
                        (slotStartHour < currentHour || (slotStartHour === currentHour && slotStartMinute <= currentMinute))) {
                        continue;
                    }

                    const slotStartTime = `${formatTime(slotStartHour)}:${formatTime(slotStartMinute)}`;
                    const slotEndTime = `${formatTime(slotEndHour)}:${formatTime(slotEndMinute)}`;

                    // Check availability for this specific slot
                    const isAvailable = checkAvailability(dateString, slotStartHour, slotStartMinute, durationMinutes, numPeople, bookingType);

                    const option = document.createElement('option');
                    option.value = `${slotStartHour}:${slotStartMinute}`;
                    option.textContent = `${slotStartTime} - ${slotEndTime}`;

                    if (!isAvailable) {
                        option.disabled = true;
                        option.textContent += " (Занято)";
                        option.classList.add('text-gray-400', 'italic');
                    } else {
                        hasAvailableSlots = true;
                    }
                    selectElement.appendChild(option);
                }
            }

            if (!hasAvailableSlots && selectElement.options.length > 0) {
                const noSlotsOption = document.createElement('option');
                noSlotsOption.textContent = "Нет доступных слотов на выбранную дату и продолжительность.";
                noSlotsOption.disabled = true;
                selectElement.appendChild(noSlotsOption);
                selectElement.value = ''; // Clear selection
            } else if (selectElement.options.length === 0) {
                 const noSlotsOption = document.createElement('option');
                noSlotsOption.textContent = "Нет доступных слотов.";
                noSlotsOption.disabled = true;
                selectElement.appendChild(noSlotsOption);
                selectElement.value = ''; // Clear selection
            } else {
                selectElement.value = selectElement.options[0].value; // Select the first available slot
            }
        }


        // --- Calculation Functions ---

        /**
         * Calculates the total price for a regular booking.
         */
        function calculateRegularPrice() {
            const dateString = regularDateInput.value;
            const numPeople = parseInt(regularPeopleInput.value);
            const durationRadio = document.querySelector('input[name="regular-duration"]:checked');
            const durationMinutes = durationRadio ? parseInt(durationRadio.value) : 0;
            const selectedTimeSlot = regularTimeSlotSelect.value;

            if (!dateString || isNaN(numPeople) || !durationMinutes || !selectedTimeSlot) {
                regularTotalPriceSpan.textContent = '0';
                regularAvailabilityMessage.classList.add('hidden');
                bookRegularBtn.disabled = true;
                bookRegularBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            const dayType = getDayType(dateString);
            const pricePerPerson = getBasePrice(durationMinutes, dayType);
            const totalPrice = pricePerPerson * numPeople;

            regularTotalPriceSpan.textContent = totalPrice;

            // Check availability for the selected slot and update message
            const [startHour, startMinute] = selectedTimeSlot.split(':').map(Number);
            const isAvailable = checkAvailability(dateString, startHour, startMinute, durationMinutes, numPeople, 'regular');

            if (!isAvailable) {
                regularAvailabilityMessage.textContent = "Это время занято или недостаточно места.";
                regularAvailabilityMessage.classList.remove('hidden');
                bookRegularBtn.disabled = true;
                bookRegularBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                regularAvailabilityMessage.classList.add('hidden');
                bookRegularBtn.disabled = false;
                bookRegularBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Calculates the total price for a birthday booking.
         */
        function calculateBirthdayPrice() {
            const dateString = birthdayDateInput.value;
            const numPeople = parseInt(birthdayPeopleInput.value);
            const startHour = parseInt(birthdayStartHourInput.value);
            const startMinute = parseInt(birthdayStartMinuteInput.value);
            const endHour = parseInt(birthdayEndHourInput.value);
            const endMinute = parseInt(birthdayEndMinuteInput.value);

            birthdayDurationMessage.classList.add('hidden');
            birthdayAvailabilityMessage.classList.add('hidden');
            bookBirthdayBtn.disabled = true;
            bookBirthdayBtn.classList.add('opacity-50', 'cursor-not-allowed');

            if (!dateString || isNaN(numPeople) || isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) {
                birthdayTotalPriceSpan.textContent = '0';
                return;
            }

            const startTime = new Date(`${dateString}T${formatTime(startHour)}:${formatTime(startMinute)}:00`);
            const endTime = new Date(`${dateString}T${formatTime(endHour)}:${formatTime(endMinute)}:00`);

            if (endTime <= startTime) {
                birthdayDurationMessage.textContent = "Время окончания должно быть позже времени начала.";
                birthdayDurationMessage.classList.remove('hidden');
                birthdayTotalPriceSpan.textContent = '0';
                return;
            }

            const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);

            if (durationMinutes < 120) {
                birthdayDurationMessage.textContent = "Минимальная продолжительность для Дня рождения - 2 часа (120 минут).";
                birthdayDurationMessage.classList.remove('hidden');
                birthdayTotalPriceSpan.textContent = '0';
                return;
            }

            if (durationMinutes % 30 !== 0) {
                birthdayDurationMessage.textContent = "Продолжительность должна быть кратна 30 минутам.";
                birthdayDurationMessage.classList.remove('hidden');
                birthdayTotalPriceSpan.textContent = '0';
                return;
            }


            const dayType = getDayType(dateString);
            const basePricePer2Hours = (dayType === 'weekend_holiday') ? 1000 : 800;
            // Calculate price based on duration relative to 2 hours (120 minutes)
            const pricePerPerson = (basePricePer2Hours / 120) * durationMinutes;
            const totalPrice = pricePerPerson * numPeople;

            birthdayTotalPriceSpan.textContent = totalPrice;

            // Check availability for birthday booking
            const isAvailable = checkAvailability(dateString, startHour, startMinute, durationMinutes, numPeople, 'birthday');
            if (!isAvailable) {
                birthdayAvailabilityMessage.textContent = "Это время занято для бронирования Дня рождения.";
                birthdayAvailabilityMessage.classList.remove('hidden');
            } else {
                bookBirthdayBtn.disabled = false;
                bookBirthdayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Calculates the total price for a group booking.
         */
        function calculateGroupPrice() {
            const dateString = groupDateInput.value;
            const numPeople = parseInt(groupPeopleInput.value);
            const durationMinutes = 60; // Fixed to 1 hour for group bookings
            const selectedTimeSlot = groupTimeSlotSelect.value;

            if (!dateString || isNaN(numPeople) || !selectedTimeSlot) {
                groupTotalPriceSpan.textContent = '0';
                groupAvailabilityMessage.classList.add('hidden');
                bookGroupBtn.disabled = true;
                bookGroupBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            if (numPeople < 10) { // Changed from 15 to 10 as per label
                groupTotalPriceSpan.textContent = '0';
                groupAvailabilityMessage.textContent = "Минимальное количество человек для группы - 10.";
                groupAvailabilityMessage.classList.remove('hidden');
                bookGroupBtn.disabled = true;
                bookGroupBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            const dayType = getDayType(dateString);
            const standardPricePerPerson = getBasePrice(durationMinutes, dayType);
            const discountedPricePerPerson = standardPricePerPerson - 50; // Discount for groups
            const totalPrice = discountedPricePerPerson * numPeople;

            groupTotalPriceSpan.textContent = totalPrice;

            // Check availability for the selected slot and update message
            const [startHour, startMinute] = selectedTimeSlot.split(':').map(Number);
            const isAvailable = checkAvailability(dateString, startHour, startMinute, durationMinutes, numPeople, 'group');

            if (!isAvailable) {
                groupAvailabilityMessage.textContent = "Это время занято или недостаточно места.";
                groupAvailabilityMessage.classList.remove('hidden');
                bookGroupBtn.disabled = true;
                bookGroupBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                groupAvailabilityMessage.classList.add('hidden');
                bookGroupBtn.disabled = false;
                bookGroupBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Event Handlers ---

        /**
         * Handles tab switching.
         * @param {Event} event - The click event.
         */
        function handleTabClick(event) {
            tabButtons.forEach(button => {
                button.classList.remove('active', 'bg-purple-700', 'hover:bg-purple-800', 'text-white', 'shadow-md');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');
            });
            event.target.classList.add('active', 'bg-purple-700', 'hover:bg-purple-800', 'text-white', 'shadow-md');
            event.target.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-200');

            bookingSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(event.target.id.replace('tab-', '') + '-booking').classList.remove('hidden');

            // Trigger initial calculation/population for the active tab
            if (event.target.id === 'tab-regular') {
                populateRegularTimeSlots();
                calculateRegularPrice();
            } else if (event.target.id === 'tab-birthday') {
                calculateBirthdayPrice();
            } else if (event.target.id === 'tab-group') {
                populateGroupTimeSlots();
                calculateGroupPrice();
            }
        }

        /**
         * Handles booking for regular visits.
         */
        async function handleBookRegular() {
            const name = regularNameInput.value.trim();
            const phone = regularPhoneInput.value.trim();
            const dateString = regularDateInput.value;
            const numPeople = parseInt(regularPeopleInput.value);
            const durationRadio = document.querySelector('input[name="regular-duration"]:checked');
            const durationMinutes = durationRadio ? parseInt(durationRadio.value) : 0;
            const selectedTimeSlot = regularTimeSlotSelect.value;
            const totalPrice = regularTotalPriceSpan.textContent;

            if (!name || !phone || !dateString || isNaN(numPeople) || !durationMinutes || !selectedTimeSlot) {
                showMessageBox("Пожалуйста, заполните все поля для бронирования.");
                return;
            }
            if (!regularPhoneInput.checkValidity()) {
                showMessageBox("Пожалуйста, введите номер телефона в формате +79000000000.");
                return;
            }

            const [startHour, startMinute] = selectedTimeSlot.split(':').map(Number);

            const isAvailable = checkAvailability(dateString, startHour, startMinute, durationMinutes, numPeople, 'regular');

            if (isAvailable) {
                const bookingData = {
                    id: generateBookingId(), // Add unique ID
                    type: 'regular',
                    name: name,
                    phone: phone,
                    date: dateString,
                    startHour: startHour,
                    startMinute: startMinute,
                    durationMinutes: durationMinutes,
                    people: numPeople
                };

                const saveResult = await saveBookingToSheet(bookingData);
                if (saveResult && saveResult.status === 'success') {
                    // Re-fetch bookings to update local state after successful save
                    await getBookingsFromSheet();
                    showMessageBox(`Бронирование успешно! Дата: ${dateString}, Время: ${selectedTimeSlot}, Человек: ${numPeople}, Продолжительность: ${durationMinutes} мин. Общая стоимость: ${totalPrice} ₽`);
                    resetRegularForm(); // Reset form after successful booking
                }
            } else {
                showMessageBox("Извините, выбранное время занято или недостаточно места. Пожалуйста, выберите другое время.");
            }
        }

        /**
         * Handles booking for birthdays.
         */
        async function handleBookBirthday() {
            const name = birthdayNameInput.value.trim();
            const phone = birthdayPhoneInput.value.trim();
            const dateString = birthdayDateInput.value;
            const numPeople = parseInt(birthdayPeopleInput.value);
            const startHour = parseInt(birthdayStartHourInput.value);
            const startMinute = parseInt(birthdayStartMinuteInput.value);
            const endHour = parseInt(birthdayEndHourInput.value);
            const endMinute = parseInt(birthdayEndMinuteInput.value);
            const totalPrice = birthdayTotalPriceSpan.textContent;

            if (!name || !phone || !dateString || isNaN(numPeople) || isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) {
                showMessageBox("Пожалуйста, заполните все поля для бронирования Дня рождения.");
                return;
            }
            if (!birthdayPhoneInput.checkValidity()) {
                showMessageBox("Пожалуйста, введите номер телефона в формате +79000000000.");
                return;
            }

            const startTime = new Date(`${dateString}T${formatTime(startHour)}:${formatTime(startMinute)}:00`);
            const endTime = new Date(`${dateString}T${formatTime(endHour)}:${formatTime(endMinute)}:00`);
            const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);

            if (durationMinutes < 120) {
                showMessageBox("Минимальная продолжительность для Дня рождения - 2 часа (120 минут).");
                return;
            }
            if (durationMinutes % 30 !== 0) {
                showMessageBox("Продолжительность должна быть кратна 30 минутам.");
                return;
            }

            const isAvailable = checkAvailability(dateString, startHour, startMinute, durationMinutes, numPeople, 'birthday');

            if (isAvailable) {
                const bookingData = {
                    id: generateBookingId(), // Add unique ID
                    type: 'birthday',
                    name: name,
                    phone: phone,
                    date: dateString,
                    startHour: startHour,
                    startMinute: startMinute,
                    durationMinutes: durationMinutes,
                    people: numPeople
                };

                const saveResult = await saveBookingToSheet(bookingData);
                if (saveResult && saveResult.status === 'success') {
                    // Re-fetch bookings to update local state after successful save
                    await getBookingsFromSheet();
                    showMessageBox(`Бронирование Дня рождения успешно! Дата: ${dateString}, Время: ${formatTime(startHour)}:${formatTime(startMinute)} - ${formatTime(endHour)}:${formatTime(endMinute)}, Человек: ${numPeople}. Общая стоимость: ${totalPrice} ₽`);
                    resetBirthdayForm(); // Reset form after successful booking
                }
            } else {
                showMessageBox("Извините, выбранное время занято для бронирования Дня рождения.");
            }
        }

        /**
         * Handles booking for groups.
         */
        async function handleBookGroup() {
            const name = groupNameInput.value.trim();
            const phone = groupPhoneInput.value.trim();
            const dateString = groupDateInput.value;
            const numPeople = parseInt(groupPeopleInput.value);
            const durationMinutes = 60; // Fixed for group
            const selectedTimeSlot = groupTimeSlotSelect.value;
            const totalPrice = groupTotalPriceSpan.textContent;

            if (!name || !phone || !dateString || isNaN(numPeople) || !selectedTimeSlot) {
                showMessageBox("Пожалуйста, заполните все поля для группового бронирования.");
                return;
            }
            if (!groupPhoneInput.checkValidity()) {
                showMessageBox("Пожалуйста, введите номер телефона в формате +79000000000.");
                return;
            }

            if (numPeople < 10) { // Minimum 10 people for group
                showMessageBox("Минимальное количество человек для группы - 10.");
                return;
            }

            const [startHour, startMinute] = selectedTimeSlot.split(':').map(Number);

            const isAvailable = checkAvailability(dateString, startHour, startMinute, durationMinutes, numPeople, 'group');

            if (isAvailable) {
                const bookingData = {
                    id: generateBookingId(), // Add unique ID
                    type: 'group',
                    name: name,
                    phone: phone,
                    date: dateString,
                    startHour: startHour,
                    startMinute: startMinute,
                    durationMinutes: durationMinutes,
                    people: numPeople
                };

                const saveResult = await saveBookingToSheet(bookingData);
                if (saveResult && saveResult.status === 'success') {
                    // Re-fetch bookings to update local state after successful save
                    await getBookingsFromSheet();
                    showMessageBox(`Групповое бронирование успешно! Дата: ${dateString}, Время: ${selectedTimeSlot}, Человек: ${numPeople}. Общая стоимость: ${totalPrice} ₽`);
                    resetGroupForm(); // Reset form after successful booking
                }
            } else {
                showMessageBox("Извините, выбранное время занято или недостаточно места для вашей группы.");
            }
        }

        /**
         * Resets the regular booking form fields.
         */
        function resetRegularForm() {
            regularNameInput.value = '';
            regularPhoneInput.value = '';
            regularPeopleInput.value = '1';
            document.getElementById('regular-date').value = new Date().toISOString().split('T')[0]; // Reset date to today
            document.querySelector('input[name="regular-duration"][value="30"]').checked = true; // Reset duration to 30 min
            populateRegularTimeSlots();
            calculateRegularPrice();
        }

        /**
         * Resets the birthday booking form fields.
         */
        function resetBirthdayForm() {
            birthdayNameInput.value = '';
            birthdayPhoneInput.value = '';
            birthdayPeopleInput.value = '1';
            document.getElementById('birthday-date').value = new Date().toISOString().split('T')[0]; // Reset date to today
            birthdayStartHourInput.value = '10';
            birthdayStartMinuteInput.value = '00';
            birthdayEndHourInput.value = '12';
            birthdayEndMinuteInput.value = '00';
            calculateBirthdayPrice();
        }

        /**
         * Resets the group booking form fields.
         */
        function resetGroupForm() {
            groupNameInput.value = '';
            groupPhoneInput.value = '';
            groupPeopleInput.value = '10'; // Reset to min group size
            document.getElementById('group-date').value = new Date().toISOString().split('T')[0]; // Reset date to today
            populateGroupTimeSlots();
            calculateGroupPrice();
        }


        /**
         * Populates time slots for regular booking based on current selections.
         */
        function populateRegularTimeSlots() {
            const dateString = regularDateInput.value;
            const durationRadio = document.querySelector('input[name="regular-duration"]:checked');
            const durationMinutes = durationRadio ? parseInt(durationRadio.value) : 0;
            const numPeople = parseInt(regularPeopleInput.value);
            if (dateString && !isNaN(numPeople) && durationMinutes) {
                populateTimeSlots(regularTimeSlotSelect, dateString, durationMinutes, numPeople, 'regular');
            } else {
                regularTimeSlotSelect.innerHTML = '<option value="">Выберите дату, количество человек и продолжительность</option>';
            }
        }

         /**
         * Populates time slots for group booking based on current selections.
         */
        function populateGroupTimeSlots() {
            const dateString = groupDateInput.value;
            const numPeople = parseInt(groupPeopleInput.value);
            const durationMinutes = 60; // Fixed for group bookings
            if (dateString && numPeople >= 10) {
                populateTimeSlots(groupTimeSlotSelect, dateString, durationMinutes, numPeople, 'group');
            } else {
                groupTimeSlotSelect.innerHTML = '<option value="">Выберите дату и количество человек (от 10)</option>';
            }
        }

        // --- Cube Generation Function ---
        function createCubes() {
            const colors = ['bg-fuchsia-500', 'bg-cyan-400', 'bg-purple-500', 'bg-pink-500', 'bg-blue-500'];
            const numCubes = 50; // Number of cubes to generate

            for (let i = 0; i < numCubes; i++) {
                const cube = document.createElement('div');
                cube.classList.add('cube');

                // Random size (small cubes)
                const size = Math.random() * 8 + 2; // Size between 2px and 10px
                cube.style.width = `${size}px`;
                cube.style.height = `${size}px`;

                // Random position
                cube.style.top = `${Math.random() * 100}%`;
                cube.style.left = `${Math.random() * 100}%`;

                // Random color
                cube.classList.add(colors[Math.floor(Math.random() * colors.length)]);

                // Random animation delay for staggered effect
                cube.style.animationDelay = `${Math.random() * 3}s`; // Delay up to 3 seconds

                cubesContainer.appendChild(cube);
            }
        }


        // --- Initial Setup and Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date as default
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            regularDateInput.value = todayString;
            birthdayDateInput.value = todayString;
            groupDateInput.value = todayString;

            // Fetch initial bookings from Google Sheet
            await getBookingsFromSheet();

            // Initial population and calculation for the default tab
            populateRegularTimeSlots();
            calculateRegularPrice();

            // Tab navigation listeners
            tabButtons.forEach(button => {
                button.addEventListener('click', handleTabClick);
            });

            // Regular Booking Listeners
            regularNameInput.addEventListener('input', calculateRegularPrice);
            regularPhoneInput.addEventListener('input', calculateRegularPrice);
            regularMinusBtn.addEventListener('click', () => {
                let val = parseInt(regularPeopleInput.value);
                if (val > 1) regularPeopleInput.value = val - 1;
                populateRegularTimeSlots();
                calculateRegularPrice();
            });
            regularPlusBtn.addEventListener('click', () => {
                let val = parseInt(regularPeopleInput.value);
                if (val < 20) regularPeopleInput.value = val + 1;
                populateRegularTimeSlots();
                calculateRegularPrice();
            });
            regularPeopleInput.addEventListener('input', () => {
                let val = parseInt(regularPeopleInput.value);
                if (isNaN(val) || val < 1) regularPeopleInput.value = 1;
                if (val > 20) regularPeopleInput.value = 20;
                populateRegularTimeSlots();
                calculateRegularPrice();
            });
            regularDateInput.addEventListener('change', () => {
                populateRegularTimeSlots();
                calculateRegularPrice();
            });
            regularDurationRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    populateRegularTimeSlots();
                    calculateRegularPrice();
                });
            });
            regularTimeSlotSelect.addEventListener('change', calculateRegularPrice);
            bookRegularBtn.addEventListener('click', handleBookRegular);

            // Birthday Booking Listeners
            birthdayNameInput.addEventListener('input', calculateBirthdayPrice);
            birthdayPhoneInput.addEventListener('input', calculateBirthdayPrice);
            birthdayMinusBtn.addEventListener('click', () => {
                let val = parseInt(birthdayPeopleInput.value);
                if (val > 1) birthdayPeopleInput.value = val - 1;
                calculateBirthdayPrice();
            });
            birthdayPlusBtn.addEventListener('click', () => {
                let val = parseInt(birthdayPeopleInput.value);
                if (val < 20) birthdayPeopleInput.value = val + 1;
                calculateBirthdayPrice();
            });
            birthdayPeopleInput.addEventListener('input', () => {
                let val = parseInt(birthdayPeopleInput.value);
                if (isNaN(val) || val < 1) birthdayPeopleInput.value = 1;
                if (val > 20) birthdayPeopleInput.value = 20;
                calculateBirthdayPrice();
            });
            birthdayDateInput.addEventListener('change', calculateBirthdayPrice);
            birthdayStartHourInput.addEventListener('input', calculateBirthdayPrice);
            birthdayStartMinuteInput.addEventListener('input', () => {
                let val = parseInt(birthdayStartMinuteInput.value);
                if (isNaN(val) || val < 0) birthdayStartMinuteInput.value = 0;
                if (val > 59) birthdayStartMinuteInput.value = 59;
                birthdayStartMinuteInput.value = Math.round(val / 30) * 30; // Snap to 0 or 30
                calculateBirthdayPrice();
            });
            birthdayEndHourInput.addEventListener('input', calculateBirthdayPrice);
            birthdayEndMinuteInput.addEventListener('input', () => {
                let val = parseInt(birthdayEndMinuteInput.value);
                if (isNaN(val) || val < 0) birthdayEndMinuteInput.value = 0;
                if (val > 59) birthdayEndMinuteInput.value = 59;
                birthdayEndMinuteInput.value = Math.round(val / 30) * 30; // Snap to 0 or 30
                calculateBirthdayPrice();
            });
            bookBirthdayBtn.addEventListener('click', handleBookBirthday);

            // Group Booking Listeners
            groupNameInput.addEventListener('input', calculateGroupPrice);
            groupPhoneInput.addEventListener('input', calculateGroupPrice);
            groupMinusBtn.addEventListener('click', () => {
                let val = parseInt(groupPeopleInput.value);
                if (val > 10) groupPeopleInput.value = val - 1; // Min 10 for group
                populateGroupTimeSlots();
                calculateGroupPrice();
            });
            groupPlusBtn.addEventListener('click', () => {
                let val = parseInt(groupPeopleInput.value);
                if (val < 100) groupPeopleInput.value = val + 1; // Max 100 for group
                populateGroupTimeSlots();
                calculateGroupPrice();
            });
            groupPeopleInput.addEventListener('input', () => {
                let val = parseInt(groupPeopleInput.value);
                if (isNaN(val) || val < 10) groupPeopleInput.value = 10; // Min 10 for group
                if (val > 100) groupPeopleInput.value = 100;
                populateGroupTimeSlots();
                calculateGroupPrice();
            });
            groupDateInput.addEventListener('change', () => {
                populateGroupTimeSlots();
                calculateGroupPrice();
            });
            groupTimeSlotSelect.addEventListener('change', calculateGroupPrice);
            bookGroupBtn.addEventListener('click', handleBookGroup);

            // Message Box Listener
            messageOkButton.addEventListener('click', hideMessageBox);

            // Generate cubes on page load
            createCubes();
        });
    </script>
</body>
</html>
